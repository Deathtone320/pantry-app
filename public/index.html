<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantry App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js" defer></script>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Pantry App</h1>

        <!-- Login Section -->
        <div id="login-section" class="mb-4">
            <h2>Login</h2>
            <input type="email" id="email" class="form-control mb-2" placeholder="Email">
            <input type="password" id="password" class="form-control mb-2" placeholder="Password">
            <button class="btn btn-primary" onclick="login()">Login</button>
            <button class="btn btn-secondary" onclick="register()">Register</button>
        </div>

        <!-- Main App (Hidden until logged in) -->
        <div id="app-section" style="display: none;">
            <!-- Barcode Scanner -->
            <div class="mb-4">
                <h2>Scan Barcode</h2>
                <div id="scanner-container" style="width: 100%; height: 300px;"></div>
                <button class="btn btn-primary mt-2" onclick="startScanner()">Start Scanner</button>
            </div>

            <!-- Manual Item Entry -->
            <div class="mb-4">
                <h2>Add Item Manually</h2>
                <input type="text" id="manual-name" class="form-control mb-2" placeholder="Item Name">
                <input type="number" id="manual-quantity" class="form-control mb-2" placeholder="Quantity">
                <input type="file" id="manual-image" class="form-control mb-2" accept="image/*">
                <button class="btn btn-primary" onclick="addManualItem()">Add Item</button>
            </div>

            <!-- Pantry List -->
            <div class="mb-4">
                <h2>My Pantry</h2>
                <ul id="pantry-list" class="list-group"></ul>
            </div>

            <!-- Recipe Suggestions -->
            <div class="mb-4">
                <h2>Recipe Suggestions</h2>
                <button class="btn btn-primary mb-2" onclick="getRecipes()">Get Recipes</button>
                <ul id="recipe-list" class="list-group"></ul>
            </div>

            <!-- Settings Menu -->
            <div class="mb-4">
                <h2>Settings</h2>
                <button class="btn btn-primary" onclick="showUserManagement()">User Management</button>
                <div id="user-management" style="display: none;">
                    <h3>Manage Users</h3>
                    <input type="email" id="new-user" class="form-control mb-2" placeholder="New User Email">
                    <button class="btn btn-primary" onclick="addUser()">Add User</button>
                    <ul id="user-list" class="list-group"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wait for the window to load and check Firebase readiness
        window.onload = function() {
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded');
                alert('Error: Firebase SDK failed to load. Please refresh the page.');
                return;
            }

            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyBhJKdi2UnZX0VFtqkKnrOIiaBWZZgC-V0",
                authDomain: "pantry-app-1a761.firebaseapp.com",
                projectId: "pantry-app-1a761",
                storageBucket: "pantry-app-1a761.firebasestorage.app",
                messagingSenderId: "276704176511",
                appId: "1:276704176511:web:2c5798af2bea513c69124a",
                measurementId: "G-L47SCE5EDN"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const storage = firebase.storage();

            // Authentication State
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('app-section').style.display = 'block';
                    loadPantry(user.uid);
                    loadUsers(user.uid);
                } else {
                    document.getElementById('login-section').style.display = 'block';
                    document.getElementById('app-section').style.display = 'none';
                }
            });

            // Login
            async function login() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    alert('Login failed: ' + error.message);
                }
            }

            // Register
            async function register() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                    alert('User registered successfully');
                } catch (error) {
                    alert('Registration failed: ' + error.message);
                }
            }

            // Start Barcode Scanner
            function startScanner() {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#scanner-container'),
                        constraints: { facingMode: "environment" }
                    },
                    decoder: { readers: ["ean_reader", "upc_reader"] }
                }, function(err) {
                    if (err) {
                        console.error(err);
                        alert('Error initializing scanner: ' + err.message);
                        return;
                    }
                    Quagga.start();
                });

                Quagga.onDetected(async (data) => {
                    const barcode = data.codeResult.code;
                    Quagga.stop();
                    await fetchItem(barcode);
                });
            }

            // Fetch Item from Open Food Facts
            async function fetchItem(barcode) {
                try {
                    const response = await axios.get(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                    if (response.data.status === 1) {
                        const product = response.data.product;
                        const item = {
                            name: product.product_name || 'Unknown Product',
                            barcode,
                            quantity: 1,
                            image: product.image_url || ''
                        };
                        await addItemToPantry(item);
                    } else {
                        alert('Product not found in database');
                    }
                } catch (error) {
                    alert('Error fetching product: ' + error.message);
                }
            }

            // Add Item to Pantry
            async function addItemToPantry(item) {
                const user = auth.currentUser;
                if (!user) return alert('Not logged in');
                try {
                    await db.collection('pantries').doc(user.uid).collection('items').add(item);
                    loadPantry(user.uid);
                } catch (error) {
                    alert('Error adding item: ' + error.message);
                }
            }

            // Add Manual Item
            async function addManualItem() {
                const user = auth.currentUser;
                if (!user) return alert('Not logged in');
                const name = document.getElementById('manual-name').value;
                const quantity = parseInt(document.getElementById('manual-quantity').value);
                const image = document.getElementById('manual-image').files[0];
                let imageUrl = '';

                if (image) {
                    const storageRef = storage.ref(`images/${user.uid}/${image.name}`);
                    await storageRef.put(image);
                    imageUrl = await storageRef.getDownloadURL();
                }

                try {
                    await db.collection('pantries').doc(user.uid).collection('items').add({
                        name,
                        quantity,
                        image: imageUrl
                    });
                    loadPantry(user.uid);
                } catch (error) {
                    alert('Error adding manual item: ' + error.message);
                }
            }

            // Load Pantry
            async function loadPantry(userId) {
                try {
                    const pantryList = document.getElementById('pantry-list');
                    pantryList.innerHTML = '';
                    const querySnapshot = await db.collection('pantries').doc(userId).collection('items').get();
                    querySnapshot.forEach(doc => {
                        const item = doc.data();
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `${item.name} (Qty: ${item.quantity}) ${item.image ? `<img src="${item.image}" width="50">` : ''}`;
                        pantryList.appendChild(li);
                    });

                    const sharedSnapshot = await db.collection('shared_pantries').where('sharedUserId', '==', userId).get();
                    for (const sharedDoc of sharedSnapshot.docs) {
                        const sharedUserId = sharedDoc.data().userId;
                        const sharedItems = await db.collection('pantries').doc(sharedUserId).collection('items').get();
                        sharedItems.forEach(doc => {
                            const item = doc.data();
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.innerHTML = `${item.name} (Qty: ${item.quantity}) ${item.image ? `<img src="${item.image}" width="50">` : ''} (Shared from ${sharedUserId})`;
                            pantryList.appendChild(li);
                        });
                    }
                } catch (error) {
                    alert('Error loading pantry: ' + error.message);
                }
            }

            // Get Recipe Suggestions
            async function getRecipes() {
                const user = auth.currentUser;
                if (!user) return alert('Not logged in');
                try {
                    const querySnapshot = await db.collection('pantries').doc(user.uid).collection('items').get();
                    const ingredients = querySnapshot.docs.map(doc => doc.data().name).join(',');
                    const response = await axios.get(`https://api.spoonacular.com/recipes/findByIngredients?ingredients=${ingredients}&apiKey=e986d8d8aea940aba2095c6b23333f61`);
                    const recipeList = document.getElementById('recipe-list');
                    recipeList.innerHTML = '';
                    response.data.forEach(recipe => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item';
                        li.innerHTML = `<a href="${recipe.sourceUrl}" target="_blank">${recipe.title}</a>`;
                        recipeList.appendChild(li);
                    });
                } catch (error) {
                    alert('Error fetching recipes: ' + error.message);
                }
            }

            // Show User Management
            function showUserManagement() {
                document.getElementById('user-management').style.display = 'block';
            }

            // Add User to Shared Pantry
            async function addUser() {
                const user = auth.currentUser;
                if (!user) return alert('Not logged in');
                const newUserEmail = document.getElementById('new-user').value;
                try {
                    const usersSnapshot = await db.collection('users').where('email', '==', newUserEmail).get();
                    if (usersSnapshot.empty) return alert('User not found');
                    const newUserId = usersSnapshot.docs[0].id;
                    await db.collection('shared_pantries').add({
                        userId: user.uid,
                        sharedUserId: newUserId
                    });
                    alert('User added successfully');
                    loadUsers(user.uid);
                } catch (error) {
                    alert('Error adding user: ' + error.message);
                }
            }

            // Load Shared Users
            async function loadUsers(userId) {
                try {
                    const userList = document.getElementById('user-list');
                    userList.innerHTML = '';
                    const querySnapshot = await db.collection('shared_pantries').where('userId', '==', userId).get();
                    for (const doc of querySnapshot.docs) {
                        const sharedUserId = doc.data().sharedUserId;
                        const userDoc = await db.collection('users').doc(sharedUserId).get();
                        if (userDoc.exists) {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.textContent = userDoc.data().email;
                            userList.appendChild(li);
                        }
                    }
                } catch (error) {
                    alert('Error loading users: ' + error.message);
                }
            }

            // Save User Email to Firestore on Registration
            auth.onAuthStateChanged(async user => {
                if (user && !user.emailVerified) {
                    await db.collection('users').doc(user.uid).set({ email: user.email });
                }
            });
        };
    </script>
</body>
</html>
