<script type="module">
    // Import Firebase modules at the top level
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, getDocs, where, doc, getDoc, setDoc, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBhJKdi2UnZX0VFtqkKnrOIiaBWZZgC-V0",
        authDomain: "pantry-app-1a761.firebaseapp.com",
        projectId: "pantry-app-1a761",
        storageBucket: "pantry-app-1a761.firebasestorage.app",
        messagingSenderId: "276704176511",
        appId: "1:276704176511:web:2c5798af2bea513c69124a",
        measurementId: "G-L47SCE5EDN"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Wait for the window to load and set up event listeners
    window.onload = function() {
        // Authentication State
        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('app-section').style.display = 'block';
                loadPantry(user.uid);
                loadUsers(user.uid);
            } else {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('app-section').style.display = 'none';
            }
        });

        // Login
        window.login = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        };

        // Register
        window.register = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await auth.createUserWithEmailAndPassword(email, password);
                alert('User registered successfully');
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        };

        // Start Barcode Scanner
        window.startScanner = function() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: { facingMode: "environment" }
                },
                decoder: { readers: ["ean_reader", "upc_reader"] }
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert('Error initializing scanner: ' + err.message);
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(async (data) => {
                const barcode = data.codeResult.code;
                Quagga.stop();
                await fetchItem(barcode);
            });
        };

        // Fetch Item from Open Food Facts
        window.fetchItem = async function(barcode) {
            try {
                const response = await axios.get(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
                if (response.data.status === 1) {
                    const product = response.data.product;
                    const item = {
                        name: product.product_name || 'Unknown Product',
                        barcode,
                        quantity: 1,
                        image: product.image_url || ''
                    };
                    await addItemToPantry(item);
                } else {
                    alert('Product not found in database');
                }
            } catch (error) {
                alert('Error fetching product: ' + error.message);
            }
        };

        // Add Item to Pantry
        window.addItemToPantry = async function(item) {
            const user = auth.currentUser;
            if (!user) return alert('Not logged in');
            try {
                await addDoc(collection(db, 'pantries', user.uid, 'items'), item);
                loadPantry(user.uid);
            } catch (error) {
                alert('Error adding item: ' + error.message);
            }
        };

        // Add Manual Item
        window.addManualItem = async function() {
            const user = auth.currentUser;
            if (!user) return alert('Not logged in');
            const name = document.getElementById('manual-name').value;
            const quantity = parseInt(document.getElementById('manual-quantity').value);
            const image = document.getElementById('manual-image').files[0];
            let imageUrl = '';

            if (image) {
                const storageRef = ref(storage, `images/${user.uid}/${image.name}`);
                await uploadBytes(storageRef, image);
                imageUrl = await getDownloadURL(storageRef);
            }

            try {
                await addDoc(collection(db, 'pantries', user.uid, 'items'), {
                    name,
                    quantity,
                    image: imageUrl
                });
                loadPantry(user.uid);
            } catch (error) {
                alert('Error adding manual item: ' + error.message);
            }
        };

        // Load Pantry
        window.loadPantry = async function(userId) {
            try {
                const pantryList = document.getElementById('pantry-list');
                pantryList.innerHTML = '';
                const querySnapshot = await getDocs(collection(db, 'pantries', userId, 'items'));
                querySnapshot.forEach(doc => {
                    const item = doc.data();
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `${item.name} (Qty: ${item.quantity}) ${item.image ? `<img src="${item.image}" width="50">` : ''}`;
                    pantryList.appendChild(li);
                });

                const sharedSnapshot = await getDocs(collection(db, 'shared_pantries'));
                for (const sharedDoc of sharedSnapshot.docs) {
                    const sharedUserId = sharedDoc.data().sharedUserId;
                    if (sharedUserId === userId) {
                        const sharedItems = await getDocs(collection(db, 'pantries', sharedDoc.data().userId, 'items'));
                        sharedItems.forEach(doc => {
                            const item = doc.data();
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.innerHTML = `${item.name} (Qty: ${item.quantity}) ${item.image ? `<img src="${item.image}" width="50">` : ''} (Shared from ${sharedDoc.data().userId})`;
                            pantryList.appendChild(li);
                        });
                    }
                }
            } catch (error) {
                alert('Error loading pantry: ' + error.message);
            }
        };

        // Get Recipe Suggestions
        window.getRecipes = async function() {
            const user = auth.currentUser;
            if (!user) return alert('Not logged in');
            try {
                const querySnapshot = await getDocs(collection(db, 'pantries', user.uid, 'items'));
                const ingredients = querySnapshot.docs.map(doc => doc.data().name).join(',');
                const response = await axios.get(`https://api.spoonacular.com/recipes/findByIngredients?ingredients=${ingredients}&apiKey=e986d8d8aea940aba2095c6b23333f61`);
                const recipeList = document.getElementById('recipe-list');
                recipeList.innerHTML = '';
                response.data.forEach(recipe => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `<a href="${recipe.sourceUrl}" target="_blank">${recipe.title}</a>`;
                    recipeList.appendChild(li);
                });
            } catch (error) {
                alert('Error fetching recipes: ' + error.message);
            }
        };

        // Show User Management
        window.showUserManagement = function() {
            document.getElementById('user-management').style.display = 'block';
        };

        // Add User to Shared Pantry
        window.addUser = async function() {
            const user = auth.currentUser;
            if (!user) return alert('Not logged in');
            const newUserEmail = document.getElementById('new-user').value;
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const userDoc = usersSnapshot.docs.find(doc => doc.data().email === newUserEmail);
                if (!userDoc) return alert('User not found');
                const newUserId = userDoc.id;
                await addDoc(collection(db, 'shared_pantries'), {
                    userId: user.uid,
                    sharedUserId: newUserId
                });
                alert('User added successfully');
                loadUsers(user.uid);
            } catch (error) {
                alert('Error adding user: ' + error.message);
            }
        };

        // Load Shared Users
        window.loadUsers = async function(userId) {
            try {
                const userList = document.getElementById('user-list');
                userList.innerHTML = '';
                const querySnapshot = await getDocs(collection(db, 'shared_pantries'));
                for (const doc of querySnapshot.docs) {
                    if (doc.data().userId === userId) {
                        const sharedUserId = doc.data().sharedUserId;
                        const userDoc = await getDoc(doc(db, 'users', sharedUserId));
                        if (userDoc.exists()) {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.textContent = userDoc.data().email;
                            userList.appendChild(li);
                        }
                    }
                }
            } catch (error) {
                alert('Error loading users: ' + error.message);
            }
        };
    };
</script>
</body>
</html>
